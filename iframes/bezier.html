<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  <title>Bezier curve</title>
  <meta name="author" content="Eltaurus">

  <link rel="icon" href="../favicon.svg" type="image/svg+xml">
  <link rel="icon" type="image/svg+xml" href="">

  <style>
    html, body {
        margin: 0;
	height: 100vh;
	inset: 0;
        overflow: clip;
    }

svg {
    inset: 0;
    margin: auto;
    box-sizing: border-box;
    width: 100%;
    height: 100%;

    //border: lightgray 1px solid;
    background: white;
}

  </style>


  <style>

svg path {
  fill: transparent;
}
svg path#spline {
  stroke: var(--accent-color, red);
  stroke-width: 4;
}
svg path[id^="tangent"] {
  stroke: black;
  stroke-width: 2;
}

svg rect {
  fill: white;
  stroke: black;
  stroke-width: 2;
}
svg :is(rect, circle) {
  cursor: grab;
}
svg :is(rect, circle):active {
  cursor: grabbing;
}

  </style>
</head>
<body>

<svg id="svgcanvas">
  <path id="spline"/>
  <path id="tangent1"/>
  <path id="tangent2"/>
  <rect x="25" y="25" width="8" height="8" />
  <circle cx="110" cy="30" r="5" />
  <circle cx="70" cy="150" r="5" />
  <rect x="145" y="145" width="8" height="8" />
</svg>

<script>
// setting color from parameters

  const params = new URLSearchParams(window.location.search);
  const color = params.get("color");
  if (color) {
    document.documentElement.style.setProperty("--accent-color", color);
  }
</script>

<script>
// general 

SVGRectElement.prototype.setPosition = function(x,y) {
  const w = this.getAttribute("width");
  this.setAttribute("x", Math.round(x - w / 2));
  this.setAttribute("y", Math.round(y - w / 2));
}
SVGRectElement.prototype.getPosition = function() {
  const w = this.getAttribute("width");
  return [
    Math.round(Number(this.getAttribute("x")) + w / 2),
    Math.round(Number(this.getAttribute("y")) + w / 2)
  ];
}
SVGCircleElement.prototype.setPosition = function(x,y) {
  this.setAttribute("cx", x);
  this.setAttribute("cy", y);
}
SVGCircleElement.prototype.getPosition = function() {
  return [
    Number(this.getAttribute("cx")),
    Number(this.getAttribute("cy"))
  ];
}

const svgCanvas = document.querySelector("svg");
const controls = [...svgCanvas.querySelectorAll("rect, circle")];

function splineUPD() {
  const P = controls.map(L => {
    const xy = L.getPosition();
    return `${xy[0]},${xy[1]}`;
  });

  document.getElementById("spline").setAttribute("d",  
              `M ${P[0]} C ${P[1]} ${P[2]} ${P[3]}`
  );
  document.getElementById("tangent1").setAttribute("d", 
              `M ${P[0]} L ${P[1]}`
  );
  document.getElementById("tangent2").setAttribute("d", 
              `M ${P[3]} L ${P[2]}`
  ); 
}

splineUPD();
</script>

<script>
// mouse interaction
active = null;

svgCanvas.addEventListener("mousedown", (e)=>{
  active = e.target;
  if (!["rect", "circle"].includes(active.tagName)) {
    active = null;
  }
  svgCanvas.edited = performance.now();
});
svgCanvas.addEventListener("mousemove", (e)=>{
  if (! e.buttons & 1) {active = null};
  if (!active) return;
  active.setPosition(e.clientX, e.clientY);
  splineUPD();
  svgCanvas.edited = performance.now();
});
</script>

<script>
// random animation

function randomIN(xmin, xmax) {
  return xmin + Math.floor(Math.random() * (xmax - xmin + 1));
}

function smoothstep(x) {
  const u = Math.min(Math.max(x,0),1);
  return u*u*(3-2*u);
}

function interpolate(from, to, prog) {
  switch (true) {
    case (typeof from === "number" && typeof to === "number"):
      return from + (to - from) * smoothstep(prog);
    case (Array.isArray(from) && Array.isArray(to) && from.length === 2 && to.length === 2):
      return [interpolate(from[0], to[0], prog), interpolate(from[1], to[1], prog)];
    case (Array.isArray(from) && Array.isArray(to) && from.length === to.length):
      return from; //todo
  }
}

setInterval(() => {
  const start = performance.now();
  console.log(svgCanvas.edited);
  if (svgCanvas.edited && start < svgCanvas.edited + 15000) return;

  svgCanvas.animationStart = start;
  const duration = 500;

  controls.forEach(L=>{
    const dim = svgCanvas.getBoundingClientRect();
    const pad = 5;
    L.from = L.getPosition();
    L.to = [
        randomIN(pad, dim.width - pad),
        randomIN(pad, dim.height - pad)
      ];
    // console.log(`${L.from} -> ${L.to}`);
  });

  function frame(now) {
    const prog = (now - start) / duration;
    controls.forEach(L=>{
      const current = interpolate(L.from, L.to, prog).map(val=>Math.round(val));
      // console.log(`${L.from} -> ${L.to}: ${current}`);
      L.setPosition(current[0], current[1]);
    });
    splineUPD();
    
    if (prog < 1) {
      requestAnimationFrame(frame);
    }
  }

  requestAnimationFrame(frame);

}, 5000);
</script>

</body>
</html>